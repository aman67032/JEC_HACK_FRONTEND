# Firebase Setup Guide for PillSync 360

## 1. Deploy Firestore Security Rules

### Option A: Firebase Console (Recommended - No installation needed)

1. Go to: https://console.firebase.google.com/project/health-connect-d256d/firestore/rules
2. Open the file: `firebase/firestore.rules` in this project
3. Copy all the content
4. Paste into the Firebase Console Rules editor
5. Click **"Publish"**

### Option B: Firebase CLI (For automated deployments)

1. Install Firebase CLI:
   ```bash
   npm install -g firebase-tools
   ```

2. Login:
   ```bash
   firebase login
   ```

3. Initialize (if first time):
   ```bash
   firebase init firestore
   ```
   - Select existing project: `health-connect-d256d`
   - Use existing `firestore.rules` file: Yes

4. Deploy rules:
   ```bash
   firebase deploy --only firestore:rules
   ```

---

## 2. Using the Admin API

### Method 1: Super Admin Page (Easiest)

1. Login to your app
2. Go to: `http://localhost:3000/admin/super`
3. Enter:
   - **Target User ID**: The Firebase UID of the user you want to make a doctor
   - **Admin API Secret**: The secret from your `.env.local` file
4. Check "Make doctor" checkbox
5. Click "Apply"

### Method 2: Command Line (curl)

**Windows PowerShell:**
```powershell
$secret = "your-admin-secret-here"
$userId = "firebase-user-id-here"

curl.exe -X POST http://localhost:3000/api/admin/setDoctor `
  -H "x-admin-secret: $secret" `
  -H "Content-Type: application/json" `
  -d "{`"userId`":`"$userId`",`"makeDoctor`":true}"
```

**Finding a User ID:**
1. Firebase Console → Authentication → Users tab
2. Copy the "User UID" column value

---

## 3. Enable Firebase Storage (For Profile Photos)

1. Go to: https://console.firebase.google.com/project/health-connect-d256d/storage
2. Click "Get Started"
3. Start in **Test mode** (we'll update rules later)
4. Click "Done"

### Storage Rules (Optional - for production):

Go to Rules tab and paste:
```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /avatars/{userId}/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

---

## 4. Enable Authentication Providers

### Email/Password Provider

1. Go to: https://console.firebase.google.com/project/health-connect-d256d/authentication/providers
2. Click on **Email/Password**
3. Toggle **Enable** to ON
4. Click **Save**

### Google Sign-In Provider (Optional)

1. Go to: https://console.firebase.google.com/project/health-connect-d256d/authentication/providers
2. Click on **Google**
3. Toggle **Enable** to ON
4. If you have a Google OAuth Client ID (e.g., `581962389987-ife7rtv4s9p3d9bkt7re6uac5al4f8e3.apps.googleusercontent.com`), you can enter it, or leave blank to use Firebase's default client ID
5. Configure your **Authorized domains**:
   - `localhost` (for local development)
   - Your production domain (e.g., `health-connect-d256d.firebaseapp.com`)
   - Any other domains where your app will be hosted
6. Click **Save**

**Note:** The Google OAuth Client ID is automatically generated by Firebase when you enable Google Sign-In. You can use the default one, or configure your own from [Google Cloud Console](https://console.cloud.google.com/).

---

## 5. Setup Environment Variables

1. Copy `.env.example` to `.env.local`:
   ```bash
   cp .env.example .env.local
   ```

2. Get your Firebase configuration values:
   - Go to: https://console.firebase.google.com/project/health-connect-d256d/settings/general
   - Scroll down to "Your apps" section
   - If you don't have a web app, click "Add app" → Web (</> icon)
   - Copy the config values from the Firebase SDK snippet:
     - `apiKey` → `NEXT_PUBLIC_FIREBASE_API_KEY`
     - `authDomain` → `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`
     - `projectId` → `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
     - `storageBucket` → `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`
     - `messagingSenderId` → `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`
     - `appId` → `NEXT_PUBLIC_FIREBASE_APP_ID`

3. Generate a strong secret for `ADMIN_API_SECRET`:
   ```bash
   # PowerShell:
   -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 32 | ForEach-Object {[char]$_})
   
   # Or use an online random string generator
   ```

4. Update `.env.local` with your values

5. Restart your dev server (required for env changes to take effect)

---

## 6. Configure Authorized Domains (For Google Sign-In)

If you enabled Google Sign-In, make sure your authorized domains are configured:

1. Go to: https://console.firebase.google.com/project/health-connect-d256d/authentication/settings
2. Scroll down to **Authorized domains**
3. Ensure the following are listed:
   - `localhost` (already added by default)
   - Your production domain if applicable
   - Any custom domains where your app will be hosted
4. Add additional domains by clicking **Add domain** if needed

**Note:** The auth handler URL (`https://health-connect-d256d.firebaseapp.com/__/auth/handler`) is automatically included in authorized domains.

---

## Checklist

- [ ] Firestore Rules deployed
- [ ] Storage enabled
- [ ] Email/Password auth enabled
- [ ] Google Sign-In enabled (optional)
- [ ] Authorized domains configured (if using Google Sign-In)
- [ ] `.env.local` file created with all Firebase keys
- [ ] `ADMIN_API_SECRET` set to a strong secret
- [ ] Dev server restarted after `.env.local` changes

---

## Quick Test Flow

1. **Create a patient account:**
   - Sign up at `/signup`
   - Go to `/profile`
   - Upload a photo, add conditions/allergies
   - Generate a share code

2. **Make someone a doctor:**
   - Note their User ID from Firebase Console
   - Use Super Admin page to assign doctor role

3. **Doctor connects to patient:**
   - Login as the doctor
   - Go to `/admin/doctor`
   - Fill profile (specialization, clinic)
   - Enter patient's share code
   - Click "Connect"

4. **Verify:**
   - Check Firebase Console → Firestore
   - Patient's `users/{patientId}` should have `privacy.shareWithDoctorIds` array
   - Doctor's `users/{doctorId}/patients/{patientId}` should exist

